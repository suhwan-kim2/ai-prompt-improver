// ğŸ¯ ìƒˆë¡œìš´ script.js - ë‹¨ìˆœí•˜ê³  ëª…í™•í•œ í”„ë¡ íŠ¸ì—”ë“œ
const $ = (id) => document.getElementById(id);

// ì „ì—­ ìƒíƒœ
const state = {
  domain: "image",
  userInput: "",
  answers: [],
  currentQuestions: [],
  isProcessing: false
};

// ğŸš€ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
  console.log('ğŸ¯ í”„ë¡¬í”„íŠ¸ ê°œì„ ê¸° ì‹œì‘');
  
  // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
  $("startBtn").onclick = startImprovement;
  $("domain").onchange = (e) => {
    state.domain = e.target.value;
    console.log('ğŸ“‚ ë„ë©”ì¸ ë³€ê²½:', state.domain);
  };
});

// ğŸš€ ë©”ì¸: í”„ë¡¬í”„íŠ¸ ê°œì„  ì‹œì‘
async function startImprovement() {
  console.log('ğŸš€ í”„ë¡¬í”„íŠ¸ ê°œì„  ì‹œì‘');
  
  // ì…ë ¥ê°’ ì²´í¬
  state.userInput = $("userInput").value.trim();
  if (!state.userInput) {
    showError('í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  // ìƒíƒœ ì´ˆê¸°í™”
  state.answers = [];
  state.currentQuestions = [];
  hideAllSections();
  showLoading('AIê°€ í”„ë¡¬í”„íŠ¸ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...');
  
  // API í˜¸ì¶œ
  await processImprovement();
}

// ğŸ”„ í”„ë¡¬í”„íŠ¸ ê°œì„  ì²˜ë¦¬
async function processImprovement() {
  console.log('ğŸ”„ API í˜¸ì¶œ:', { 
    userInput: state.userInput, 
    answers: state.answers, 
    domain: state.domain 
  });
  
  if (state.isProcessing) {
    console.log('âš ï¸ ì´ë¯¸ ì²˜ë¦¬ ì¤‘');
    return;
  }
  
  state.isProcessing = true;
  
  try {
    const response = await fetch('/api/improve-prompt', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        userInput: state.userInput,
        answers: state.answers,
        domain: state.domain
      })
    });
    
    console.log('ğŸ“¡ API ì‘ë‹µ ìƒíƒœ:', response.status);
    
    const result = await response.json();
    console.log('ğŸ“¨ API ì‘ë‹µ ë°ì´í„°:', result);
    
    if (result.success) {
      // âœ… ì„±ê³µ - ê°œì„ ëœ í”„ë¡¬í”„íŠ¸ í‘œì‹œ
      showSuccess(result);
    } else if (result.action === 'need_more_info') {
      // â“ ì •ë³´ ë¶€ì¡± - ì¶”ê°€ ì§ˆë¬¸ í‘œì‹œ
      showMoreQuestions(result);
    } else if (result.error) {
      // âŒ ì˜¤ë¥˜ - ì •ì§í•œ ì‹¤íŒ¨ ì•ˆë‚´
      showFailure(result);
    } else {
      // ì˜ˆìƒì¹˜ ëª»í•œ ì‘ë‹µ
      showError('ì˜ˆìƒì¹˜ ëª»í•œ ì‘ë‹µì…ë‹ˆë‹¤.');
    }
    
  } catch (error) {
    console.error('âŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜:', error);
    showNetworkError();
  } finally {
    state.isProcessing = false;
    hideLoading();
  }
}

// âœ… ì„±ê³µ - ê°œì„ ëœ í”„ë¡¬í”„íŠ¸ í‘œì‹œ
function showSuccess(result) {
  console.log('âœ… ì„±ê³µ ê²°ê³¼ í‘œì‹œ');
  
  const successHTML = `
    <div class="success-container">
      <div class="success-header">
        <h2>ğŸ‰ ì™„ì„±!</h2>
        <div class="score-badge">ì ìˆ˜: ${result.score}ì </div>
      </div>
      
      <div class="original-prompt">
        <h3>ğŸ“ ì›ë³¸ í”„ë¡¬í”„íŠ¸</h3>
        <p class="prompt-text original">${state.userInput}</p>
        ${state.answers.length > 0 ? `
          <div class="additional-info">
            <strong>ì¶”ê°€ ì •ë³´:</strong> ${state.answers.join(', ')}
          </div>
        ` : ''}
      </div>
      
      <div class="improved-prompt">
        <h3>âœ¨ AIê°€ ê°œì„ í•œ í”„ë¡¬í”„íŠ¸</h3>
        <p class="prompt-text improved">${result.improved}</p>
        <div class="improvement-stats">
          <span class="stat">ì›ë³¸: ${result.originalLength || state.userInput.length}ì</span>
          <span class="stat">ê°œì„ : ${result.improvedLength || result.improved.length}ì</span>
          <span class="stat">ë°©ë²•: ${result.method}</span>
        </div>
      </div>
      
      <div class="action-buttons">
        <button class="btn btn-primary" onclick="copyToClipboard()">
          ğŸ“‹ ë³µì‚¬í•˜ê¸°
        </button>
        <button class="btn btn-secondary" onclick="startNew()">
          ğŸ”„ ìƒˆë¡œ ë§Œë“¤ê¸°
        </button>
        <button class="btn btn-tertiary" onclick="showDetails()">
          ğŸ“Š ìƒì„¸ë³´ê¸°
        </button>
      </div>
    </div>
  `;
  
  $("final").innerHTML = successHTML;
  $("final").classList.remove("hidden");
  
  // ê²°ê³¼ ì €ì¥ (ë³µì‚¬ ê¸°ëŠ¥ìš©)
  window.lastImproved = result.improved;
}

// â“ ì¶”ê°€ ì§ˆë¬¸ í‘œì‹œ
function showMoreQuestions(result) {
  console.log('â“ ì¶”ê°€ ì§ˆë¬¸ í‘œì‹œ:', result.questions);
  
  state.currentQuestions = result.questions;
  
  const questionsHTML = `
    <div class="questions-container">
      <div class="progress-section">
        <div class="progress-bar">
          <div class="progress-fill" style="width: ${result.completeness}%"></div>
        </div>
        <p class="progress-text">${result.message}</p>
      </div>
      
      <div class="questions-list">
        ${result.questions.map((q, index) => `
          <div class="question-item" data-key="${q.key}">
            <h4 class="question-title">${q.question}</h4>
            <p class="question-hint">${q.placeholder}</p>
            
            <div class="quick-options">
              ${q.options.map(option => `
                <button class="option-btn" data-value="${option}" onclick="selectOption('${q.key}', '${option}')">
                  ${option}
                </button>
              `).join('')}
            </div>
            
            <div class="custom-input" id="custom-${q.key}" style="display: none;">
              <input type="text" placeholder="${q.placeholder}" id="input-${q.key}" />
              <button class="btn btn-small" onclick="submitCustomAnswer('${q.key}')">í™•ì¸</button>
            </div>
          </div>
        `).join('')}
      </div>
      
      <div class="questions-footer">
        <button class="btn btn-primary" onclick="submitAllAnswers()" disabled id="submitBtn">
          ë‹µë³€ ì™„ë£Œ
        </button>
        <button class="btn btn-secondary" onclick="skipQuestions()">
          í˜„ì¬ ì •ë³´ë¡œ ì§„í–‰
        </button>
      </div>
    </div>
  `;
  
  $("questions").innerHTML = questionsHTML;
  $("questions").classList.remove("hidden");
}

// ğŸ¯ ì˜µì…˜ ì„ íƒ ì²˜ë¦¬
function selectOption(questionKey, selectedValue) {
  console.log('ğŸ¯ ì˜µì…˜ ì„ íƒ:', questionKey, selectedValue);
  
  if (selectedValue === 'ì§ì ‘ ì…ë ¥') {
    // ì»¤ìŠ¤í…€ ì…ë ¥ í•„ë“œ í‘œì‹œ
    const customDiv = $(`custom-${questionKey}`);
    customDiv.style.display = 'block';
    $(`input-${questionKey}`).focus();
    
    // ë‹¤ë¥¸ ë²„íŠ¼ë“¤ ë¹„í™œì„±í™”
    const questionDiv = document.querySelector(`[data-key="${questionKey}"]`);
    const otherButtons = questionDiv.querySelectorAll('.option-btn');
    otherButtons.forEach(btn => {
      if (btn.dataset.value !== 'ì§ì ‘ ì…ë ¥') {
        btn.disabled = true;
        btn.style.opacity = '0.5';
      }
    });
  } else {
    // ë°”ë¡œ ë‹µë³€ìœ¼ë¡œ ì„¤ì •
    setAnswer(questionKey, selectedValue);
  }
}

// âœï¸ ì»¤ìŠ¤í…€ ë‹µë³€ ì œì¶œ
function submitCustomAnswer(questionKey) {
  const inputValue = $(`input-${questionKey}`).value.trim();
  
  if (!inputValue) {
    alert('ë‹µë³€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  console.log('âœï¸ ì»¤ìŠ¤í…€ ë‹µë³€:', questionKey, inputValue);
  setAnswer(questionKey, inputValue);
}

// ğŸ“ ë‹µë³€ ì„¤ì • ë° UI ì—…ë°ì´íŠ¸
function setAnswer(questionKey, answerValue) {
  console.log('ğŸ“ ë‹µë³€ ì„¤ì •:', questionKey, '=', answerValue);
  
  // ë‹µë³€ ì €ì¥
  const existingIndex = state.answers.findIndex(a => a.startsWith(`${questionKey}:`));
  const newAnswer = `${questionKey}: ${answerValue}`;
  
  if (existingIndex >= 0) {
    state.answers[existingIndex] = newAnswer;
  } else {
    state.answers.push(newAnswer);
  }
  
  // UI ì—…ë°ì´íŠ¸ - í•´ë‹¹ ì§ˆë¬¸ì„ ì™„ë£Œ ìƒíƒœë¡œ í‘œì‹œ
  const questionDiv = document.querySelector(`[data-key="${questionKey}"]`);
  if (questionDiv) {
    questionDiv.classList.add('answered');
    
    // ì„ íƒëœ ë‹µë³€ í‘œì‹œ
    const answerDisplay = document.createElement('div');
    answerDisplay.className = 'selected-answer';
    answerDisplay.innerHTML = `<strong>ì„ íƒ:</strong> ${answerValue} âœ“`;
    
    // ê¸°ì¡´ ë‹µë³€ í‘œì‹œ ì œê±° í›„ ìƒˆë¡œ ì¶”ê°€
    const existingAnswer = questionDiv.querySelector('.selected-answer');
    if (existingAnswer) {
      existingAnswer.remove();
    }
    questionDiv.appendChild(answerDisplay);
    
    // ì˜µì…˜ ë²„íŠ¼ë“¤ ë¹„í™œì„±í™”
    const optionButtons = questionDiv.querySelectorAll('.option-btn');
    optionButtons.forEach(btn => {
      btn.disabled = true;
      btn.style.opacity = '0.5';
      if (btn.dataset.value === answerValue || (answerValue !== 'ì§ì ‘ ì…ë ¥' && btn.dataset.value !== 'ì§ì ‘ ì…ë ¥')) {
        btn.style.opacity = '0.8';
      }
    });
    
    // ì»¤ìŠ¤í…€ ì…ë ¥ ìˆ¨ê¹€
    const customInput = questionDiv.querySelector('.custom-input');
    if (customInput) {
      customInput.style.display = 'none';
    }
  }
  
  // ì œì¶œ ë²„íŠ¼ í™œì„±í™” ì²´í¬
  updateSubmitButton();
}

// ğŸ”„ ì œì¶œ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
function updateSubmitButton() {
  const totalQuestions = state.currentQuestions.length;
  const answeredQuestions = state.answers.length;
  
  const submitBtn = $("submitBtn");
  if (submitBtn) {
    if (answeredQuestions > 0) {
      submitBtn.disabled = false;
      submitBtn.textContent = `ë‹µë³€ ì™„ë£Œ (${answeredQuestions}/${totalQuestions})`;
    } else {
      submitBtn.disabled = true;
      submitBtn.textContent = 'ë‹µë³€ ì™„ë£Œ';
    }
  }
}

// ğŸ“¤ ëª¨ë“  ë‹µë³€ ì œì¶œ
async function submitAllAnswers() {
  console.log('ğŸ“¤ ë‹µë³€ ì œì¶œ:', state.answers);
  
  if (state.answers.length === 0) {
    alert('ìµœì†Œ 1ê°œ ì´ìƒì˜ ì§ˆë¬¸ì— ë‹µë³€í•´ì£¼ì„¸ìš”.');
    return;
  }
  
  hideAllSections();
  showLoading('ë‹µë³€ì„ ë°”íƒ•ìœ¼ë¡œ í”„ë¡¬í”„íŠ¸ë¥¼ ê°œì„ í•˜ê³  ìˆìŠµë‹ˆë‹¤...');
  
  // ë‹¤ì‹œ API í˜¸ì¶œ
  await processImprovement();
}

// â­ï¸ ì§ˆë¬¸ ê±´ë„ˆë›°ê¸° (í˜„ì¬ ì •ë³´ë¡œ ì§„í–‰)
async function skipQuestions() {
  console.log('â­ï¸ ì§ˆë¬¸ ê±´ë„ˆë›°ê¸°');
  
  const confirmSkip = confirm('í˜„ì¬ ì •ë³´ë§Œìœ¼ë¡œ í”„ë¡¬í”„íŠ¸ë¥¼ ë§Œë“œì‹œê² ìŠµë‹ˆê¹Œ?\nì™„ì„±ë„ê°€ ë‚®ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
  if (!confirmSkip) {
    return;
  }
  
  hideAllSections();
  showLoading('í˜„ì¬ ì •ë³´ë¡œ í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...');
  
  // ê°•ì œë¡œ API í˜¸ì¶œ (answersëŠ” í˜„ì¬ê¹Œì§€ ì…ë ¥ëœ ê²ƒë§Œ)
  await processImprovement();
}

// âŒ ì‹¤íŒ¨ ì•ˆë‚´ í‘œì‹œ
function showFailure(result) {
  console.log('âŒ ì‹¤íŒ¨ ê²°ê³¼ í‘œì‹œ:', result);
  
  const failureHTML = `
    <div class="failure-container">
      <div class="failure-icon">ğŸ˜</div>
      <h2 class="failure-title">${result.title}</h2>
      <p class="failure-message">${result.message}</p>
      <p class="failure-suggestion">${result.suggestion}</p>
      
      ${result.canRetry ? `
        <div class="failure-actions">
          <button class="btn btn-primary" onclick="retryImprovement()">
            ğŸ”„ ë‹¤ì‹œ ì‹œë„
          </button>
          <button class="btn btn-secondary" onclick="goBack()">
            â† ëŒì•„ê°€ê¸°
          </button>
        </div>
      ` : `
        <div class="failure-actions">  
          <button class="btn btn-secondary" onclick="goBack()">
            â† ëŒì•„ê°€ê¸°
          </button>
          <div class="wait-notice">
            <p>â° ë³´í†µ ëª‡ ì‹œê°„ í›„ì— ë‹¤ì‹œ ì •ìƒí™”ë©ë‹ˆë‹¤</p>
            <p class="timestamp">ë¬¸ì œ ë°œìƒ ì‹œê°: ${new Date(result.timestamp).toLocaleString()}</p>
          </div>
        </div>
      `}
    </div>
  `;
  
  $("final").innerHTML = failureHTML;
  $("final").classList.remove("hidden");
}

// ğŸŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ í‘œì‹œ
function showNetworkError() {
  console.log('ğŸŒ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ í‘œì‹œ');
  
  const networkErrorHTML = `
    <div class="failure-container">
      <div class="failure-icon">ğŸŒ</div>
      <h2 class="failure-title">ì—°ê²° ì˜¤ë¥˜</h2>
      <p class="failure-message">ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</p>
      <p class="failure-suggestion">ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>
      
      <div class="failure-actions">
        <button class="btn btn-primary" onclick="retryImprovement()">
          ğŸ”„ ë‹¤ì‹œ ì‹œë„
        </button>
        <button class="btn btn-secondary" onclick="goBack()">
          â† ëŒì•„ê°€ê¸°
        </button>
      </div>
    </div>
  `;
  
  $("final").innerHTML = networkErrorHTML;
  $("final").classList.remove("hidden");
}

// ğŸ”„ ì¬ì‹œë„
async function retryImprovement() {
  console.log('ğŸ”„ ì¬ì‹œë„');
  hideAllSections();
  showLoading('ë‹¤ì‹œ ì‹œë„í•˜ê³  ìˆìŠµë‹ˆë‹¤...');
  await processImprovement();
}

// â† ëŒì•„ê°€ê¸°
function goBack() {
  console.log('â† ëŒì•„ê°€ê¸°');
  hideAllSections();
  $("userInput").focus();
  
  // ìƒíƒœ ë¶€ë¶„ ë¦¬ì…‹ (ì‚¬ìš©ì ì…ë ¥ì€ ìœ ì§€)
  state.answers = [];
  state.currentQuestions = [];
}

// ğŸ”„ ìƒˆë¡œ ë§Œë“¤ê¸°
function startNew() {
  console.log('ğŸ”„ ìƒˆë¡œ ë§Œë“¤ê¸°');
  
  // ì „ì²´ ìƒíƒœ ë¦¬ì…‹
  state.userInput = "";
  state.answers = [];
  state.currentQuestions = [];
  
  // UI ë¦¬ì…‹
  $("userInput").value = "";
  hideAllSections();
  $("userInput").focus();
  
  // ì €ì¥ëœ ê²°ê³¼ ì œê±°
  window.lastImproved = null;
}

// ğŸ“‹ í´ë¦½ë³´ë“œì— ë³µì‚¬
async function copyToClipboard() {
  if (!window.lastImproved) {
    alert('ë³µì‚¬í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');
    return;
  }
  
  try {
    await navigator.clipboard.writeText(window.lastImproved);
    
    // ì„±ê³µ í”¼ë“œë°±
    const copyBtn = document.querySelector('.btn.btn-primary');
    if (copyBtn) {
      const originalText = copyBtn.textContent;
      copyBtn.textContent = 'âœ… ë³µì‚¬ë¨!';
      copyBtn.style.background = '#28a745';
      
      setTimeout(() => {
        copyBtn.textContent = originalText;
        copyBtn.style.background = '';
      }, 2000);
    }
    
    console.log('ğŸ“‹ í´ë¦½ë³´ë“œ ë³µì‚¬ ì„±ê³µ');
  } catch (error) {
    console.error('ğŸ“‹ í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', error);
    
    // í´ë°±: í…ìŠ¤íŠ¸ ì„ íƒ
    const textArea = document.createElement('textarea');
    textArea.value = window.lastImproved;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand('copy');
    document.body.removeChild(textArea);
    
    alert('í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
  }
}

// ğŸ“Š ìƒì„¸ë³´ê¸°
function showDetails() {
  const details = `
ì›ë³¸ ì…ë ¥: ${state.userInput}
ì¶”ê°€ ë‹µë³€: ${state.answers.join(' | ')}
ë„ë©”ì¸: ${state.domain}
ì²˜ë¦¬ ì‹œê°: ${new Date().toLocaleString()}
ê°œì„  ê¸¸ì´: ${window.lastImproved ? window.lastImproved.length : 0}ì
  `;
  
  alert(details);
}

// ğŸ¨ UI ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
function hideAllSections() {
  $("questions").classList.add("hidden");
  $("final").classList.add("hidden");
}

function showLoading(message) {
  // ê°„ë‹¨í•œ ë¡œë”© í‘œì‹œ
  const loadingHTML = `
    <div class="loading-container">
      <div class="loading-spinner"></div>
      <p class="loading-message">${message}</p>
    </div>
  `;
  
  $("questions").innerHTML = loadingHTML;
  $("questions").classList.remove("hidden");
}

function hideLoading() {
  // ë¡œë”© ìƒíƒœëŠ” ë‹¤ë¥¸ í•¨ìˆ˜ì—ì„œ ì²˜ë¦¬í•˜ë¯€ë¡œ ë³„ë„ ì‘ì—… ì—†ìŒ
}

function showError(message) {
  alert(message);
  console.error('âŒ ì—ëŸ¬:', message);
}

// ğŸ¯ ì „ì—­ ìƒíƒœ ë””ë²„ê¹… (ê°œë°œìš©)
function debugState() {
  console.log('ğŸ¯ í˜„ì¬ ìƒíƒœ:', {
    domain: state.domain,
    userInput: state.userInput,
    answers: state.answers,
    questionsCount: state.currentQuestions.length,
    isProcessing: state.isProcessing
  });
}

// ê°œë°œ ëª¨ë“œì—ì„œ ë””ë²„ê¹… í•¨ìˆ˜ ë…¸ì¶œ
if (typeof window !== 'undefined') {
  window.debugState = debugState;
  window.state = state; // ìƒíƒœ ì§ì ‘ ì ‘ê·¼ (ë””ë²„ê¹…ìš©)
}
